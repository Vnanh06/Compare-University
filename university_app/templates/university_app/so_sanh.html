{% extends 'university_app/base.html' %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% load dict_extras %}

{% block title %}So sánh Trường đại học{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="bg-light py-3">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'university_app:trang_chu' %}">Trang chủ</a></li>
            <li class="breadcrumb-item active">So sánh</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="page-header text-center mb-5">
                <h1 class="fw-bold">
                    <i class="fas fa-balance-scale text-primary me-3" id="pageHeaderIcon"></i>
                    So sánh Trường đại học
                </h1>
                <p class="lead text-muted" id="pageHeaderSubtext">
                    So sánh chi tiết các trường đại học với sự hỗ trợ của AI
                </p>
            </div>
        </div>
    </div>

    <!-- Comparison List Management -->
    {% if show_comparison_interface %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="comparison-management-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="fw-bold mb-0">
                        <i class="fas fa-list text-primary me-2"></i>
                        Danh Sách So sánh ({{ comparison_count }}/5)
                    </h3>
                    <a href="{% url 'university_app:so_sanh' %}?clear_all=true" 
                       class="btn btn-outline-danger"
                       onclick="return confirm('Bạn có chắc muốn xóa toàn bộ danh sách so sánh?')">
                        <i class="fas fa-trash me-2"></i>Xóa Tất Cả
                    </a>
                </div>
                
                <div class="comparison-universities">
                    {% for university in comparison_list %}
                    <div class="university-comparison-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="university-info">
                                <h5 class="mb-1">{{ university }}</h5>
                                <small class="text-muted">
                                    <i class="fas fa-university me-1"></i>Trường đại học
                                </small>
                            </div>
                            <a href="{% url 'university_app:so_sanh' %}?remove_university={{ university }}" 
                               class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Bạn có chắc muốn xóa {{ university }} khỏi danh sách so sánh?')">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Major Selection for Comparison -->
                {% if comparison_count >= 2 %}
                <div class="major-selection-section mt-4">
                    <h4 class="fw-bold mb-3">
                        <i class="fas fa-graduation-cap me-2"></i>Chọn Chuyên ngành So sánh
                    </h4>
                    
                    {% if common_majors %}
                    <p class="text-muted mb-3">
                        Chỉ hiển thị các chuyên ngành có ở tất cả {{ comparison_count }} trường được chọn
                    </p>
                    
                    <form method="GET" action="{% url 'university_app:so_sanh' %}" id="compareForm">
                        <div class="row g-3">
                            <div class="col-lg-8">
                                <select name="ma_chuyen_nganh" class="form-select form-select-lg" required>
                                    <option value="">Chọn chuyên ngành để so sánh...</option>
                                    {% for major in common_majors %}
                                    <option value="{{ major.name }}"
                                            {% if ma_chuyen_nganh_chon == major.name %}selected{% endif %}>
                                        {{ major.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="compareBtn">
                                    <i class="fas fa-balance-scale me-2"></i>So sánh Ngay
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Các trường đã chọn không có chuyên ngành chung nào. Vui lòng thêm các trường có chuyên ngành tương tự.
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}






    <!-- Comparison Results -->
    {% if da_co_ket_qua and truong_duoc_chon %}
    <div class="comparison-results">
        <!-- AI Analysis Section -->
        {% if ket_qua_ai %}
        <div class="row mb-5">
            <div class="col-12">
                <div class="ai-analysis-section" id="ai-analysis-container" style="position: relative;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h3 class="fw-bold mb-2">
                                <i class="fas fa-robot text-white me-2"></i>
                                Phân tích AI - {{ ten_chuyen_nganh }}
                            </h3>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-sparkles me-1"></i>Powered by Google Gemini 2.5 Flash
                            </span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-light me-2" id="toggle-ai-btn">
                                <i class="fas fa-eye me-2"></i><span id="toggle-text">Ẩn</span>
                            </button>
                            <button type="button" class="btn btn-light" onclick="luuKetQuaSoSanh()">
                                <i class="fas fa-save me-2"></i>Lưu Kết quả
                            </button>
                        </div>
                    </div>

                    <div class="ai-content-wrapper" id="ai-content-wrapper">
                        <div class="ai-content" id="ai-content-main">
                            <div class="ai-analysis-text" id="ai-analysis-rendered"></div>
                        </div>
                    </div>

                    <!-- Loading Overlay - Only for AI section -->
                    <div id="loadingOverlay" class="ai-loading-overlay" style="display: none;">
                        <div class="loading-content">
                            <div class="spinner-border text-white" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 fw-bold text-white">Đang phân tích với AI...</p>
                            <p class="text-white-50">Vui lòng đợi 10-15 giây</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Show loading when waiting for AI analysis -->
        <div class="row mb-5" id="aiLoadingSection" style="display: none;">
            <div class="col-12">
                <div class="ai-analysis-section" style="position: relative; min-height: 300px;">
                    <div class="ai-loading-overlay" style="display: flex;">
                        <div class="loading-content">
                            <div class="spinner-border text-white" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 fw-bold text-white">Đang phân tích với AI...</p>
                            <p class="text-white-50">Vui lòng đợi 10-15 giây</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comparison Table -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="comparison-table-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold mb-0">
                            <i class="fas fa-table text-primary me-2"></i>
                            Bảng So sánh Chi tiết - {{ ten_chuyen_nganh }}
                        </h3>
                        <a href="{% url 'university_app:so_sanh' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-plus me-2"></i>Thêm Trường Khác
                        </a>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered comparison-table">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col" class="criteria-col">Tiêu Chí</th>
                                    {% for truong in truong_duoc_chon %}
                                    <th scope="col" class="text-center university-col">
                                        <div class="university-header-cell">
                                            <div class="university-name">{{ truong.ten_truong }}</div>
                                            <div class="university-actions mt-2">
                                                <a href="{% url 'university_app:so_sanh' %}?remove_university={{ truong.ten_truong }}" 
                                                   class="btn btn-outline-light btn-sm"
                                                   onclick="return confirm('Xóa {{ truong.ten_truong }} khỏi so sánh?')">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-globe me-2"></i>Quốc gia
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">{{ truong.quoc_gia }}</td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-trophy me-2"></i>Xếp hạng Thế Giới
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi %}
                                            <span class="badge bg-success">Top {{ truong.xep_hang_the_gioi }}</span>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-dollar-sign me-2"></i>Học phí (USD/năm)
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.hoc_phi %}
                                            <span class="fw-bold text-warning">${{ truong.hoc_phi|floatformat:0 }}</span>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-calendar me-2"></i>Năm thành lập
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.nam_thanh_lap %}
                                            <span class="badge bg-info">{{ truong.nam_thanh_lap }}</span>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-clock me-2"></i>Thời gian học
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.thoi_gian_hoc %}
                                            <span class="badge bg-primary">{{ truong.thoi_gian_hoc }}</span>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-graduation-cap me-2"></i>Cấp độ
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.cap_do %}
                                            <span class="badge bg-secondary">{{ truong.cap_do }}</span>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <!-- Thông tin bổ sung -->
                                <tr class="table-active">
                                    <td colspan="{{ truong_duoc_chon|length|add:1 }}" class="text-center fw-bold bg-light">
                                        <i class="fas fa-star me-2"></i>ĐÁNH GIÁ CHẤT LƯỢNG
                                    </td>
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-chalkboard-teacher me-2"></i>Chất lượng Giảng dạy
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 50 %}
                                            <span class="text-success fw-bold">★★★★★ (9.5/10)</span>
                                        {% elif truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 100 %}
                                            <span class="text-success fw-bold">★★★★☆ (9.0/10)</span>
                                        {% else %}
                                            <span class="text-primary fw-bold">★★★★☆ (8.5/10)</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-building me-2"></i>Cơ sở Vật chất
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 50 %}
                                            <span class="text-success fw-bold">★★★★★ (9.8/10)</span>
                                        {% elif truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 100 %}
                                            <span class="text-success fw-bold">★★★★☆ (9.2/10)</span>
                                        {% else %}
                                            <span class="text-primary fw-bold">★★★★☆ (8.8/10)</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-users me-2"></i>Tỷ lệ Sinh viên/Giảng viên
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 50 %}
                                            <span class="badge bg-success">6:1</span>
                                            <small class="d-block text-muted mt-1">Rất tốt</small>
                                        {% elif truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 100 %}
                                            <span class="badge bg-info">9:1</span>
                                            <small class="d-block text-muted mt-1">Tốt</small>
                                        {% else %}
                                            <span class="badge bg-primary">12:1</span>
                                            <small class="d-block text-muted mt-1">Khá tốt</small>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-award me-2"></i>Học bổng
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        <span class="badge bg-success mb-1">
                                            <i class="fas fa-check me-1"></i>Có
                                        </span>
                                        <small class="d-block text-muted">Merit-based & Need-based</small>
                                    </td>
                                    {% endfor %}
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-briefcase me-2"></i>Tỷ lệ Việc làm
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 50 %}
                                            <span class="badge bg-success">95%</span>
                                            <small class="d-block text-muted mt-1">Trong 6 tháng</small>
                                        {% elif truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 100 %}
                                            <span class="badge bg-info">92%</span>
                                            <small class="d-block text-muted mt-1">Trong 6 tháng</small>
                                        {% else %}
                                            <span class="badge bg-primary">88%</span>
                                            <small class="d-block text-muted mt-1">Trong 6 tháng</small>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-flask me-2"></i>Cơ hội Nghiên cứu
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 50 %}
                                            <span class="text-success fw-bold">★★★★★</span>
                                            <small class="d-block text-muted">Xuất sắc</small>
                                        {% elif truong.xep_hang_the_gioi and truong.xep_hang_the_gioi <= 100 %}
                                            <span class="text-success fw-bold">★★★★☆</span>
                                            <small class="d-block text-muted">Rất tốt</small>
                                        {% else %}
                                            <span class="text-primary fw-bold">★★★★☆</span>
                                            <small class="d-block text-muted">Tốt</small>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>

                                <!-- Yêu cầu tuyển sinh -->
                                {% if truong_duoc_chon.0.yeu_cau_tuyen_sinh %}
                                    {% for criteria, value in truong_duoc_chon.0.yeu_cau_tuyen_sinh.items %}
                                    <tr>
                                        <td class="fw-bold">
                                            <i class="fas fa-clipboard-check me-2"></i>{{ criteria }}
                                        </td>
                                        {% for truong in truong_duoc_chon %}
                                        <td class="text-center">
                                            {% if truong.yeu_cau_tuyen_sinh and criteria in truong.yeu_cau_tuyen_sinh %}
                                                <span class="badge bg-warning text-dark">{{ truong.yeu_cau_tuyen_sinh|lookup:criteria }}</span>
                                            {% else %}
                                                <span class="text-muted">Chưa có</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                                
                                <tr>
                                    <td class="fw-bold">
                                        <i class="fas fa-link me-2"></i>Website
                                    </td>
                                    {% for truong in truong_duoc_chon %}
                                    <td class="text-center">
                                        {% if truong.website %}
                                            <a href="http://{{ truong.website }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-external-link-alt me-1"></i>Truy cập
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Chưa có</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h3>Biểu đồ học phí theo chuyên ngành</h3>
<canvas id="tuitionChart" width="800" height="400"></canvas>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rawTuitionData = {{ tuition_chart_data|safe }};
        const selectedMajor = "{{ ten_chuyen_nganh }}";  // đã có trong context
        
        const labels = [];
        const data = [];

        for (const uniName in rawTuitionData) {
            const majors = rawTuitionData[uniName];
            if (selectedMajor in majors) {
                // Tính học phí trung bình nếu có nhiều chương trình cùng ngành
                const tuitionList = majors[selectedMajor];
                const avgTuition = tuitionList.reduce((a, b) => a + b, 0) / tuitionList.length;
                labels.push(uniName);
                data.push(avgTuition);
            }
        }

        const ctx = document.getElementById('tuitionChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Học phí trung bình (USD)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'USD'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `So sánh học phí chuyên ngành "${selectedMajor}"`
                    }
                }
            }
        });
    });
</script>

<!-- Radar Chart - So sánh đa chiều -->
<div class="row mt-5">
    <div class="col-12">
        <div class="chart-section p-4 bg-white rounded shadow-sm">
            <h3 class="mb-4">
                <i class="fas fa-chart-area text-primary me-2"></i>
                Biểu đồ So sánh Đa chiều
            </h3>
            <p class="text-muted mb-4">So sánh tổng quan các trường theo nhiều tiêu chí</p>
            <canvas id="radarChart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const universities = {{ truong_duoc_chon|safe|default:"[]" }};

    if (!universities || universities.length === 0) return;

    // Tính điểm cho từng tiêu chí (scale 0-10)
    const datasets = universities.map((uni, index) => {
        const ranking = uni.xep_hang_the_gioi || 200;
        const tuition = uni.hoc_phi || 50000;

        // Điểm xếp hạng (ranking thấp = điểm cao)
        let rankingScore = 10;
        if (ranking > 100) rankingScore = 6;
        else if (ranking > 50) rankingScore = 8;

        // Điểm chất lượng giảng dạy
        let teachingScore = 8.5;
        if (ranking <= 50) teachingScore = 9.5;
        else if (ranking <= 100) teachingScore = 9.0;

        // Điểm cơ sở vật chất
        let facilityScore = 8.8;
        if (ranking <= 50) facilityScore = 9.8;
        else if (ranking <= 100) facilityScore = 9.2;

        // Điểm tỷ lệ việc làm
        let employmentScore = 8.8;
        if (ranking <= 50) employmentScore = 9.5;
        else if (ranking <= 100) employmentScore = 9.2;

        // Điểm cơ hội nghiên cứu
        let researchScore = 8.5;
        if (ranking <= 50) researchScore = 10;
        else if (ranking <= 100) researchScore = 9;

        // Điểm giá trị tiền (học phí thấp = điểm cao)
        let valueScore = 10 - Math.min(tuition / 10000, 5);

        // Màu sắc cho từng trường
        const colors = [
            'rgba(54, 162, 235, 0.5)',   // Blue
            'rgba(255, 99, 132, 0.5)',   // Red
            'rgba(75, 192, 192, 0.5)',   // Green
            'rgba(255, 206, 86, 0.5)',   // Yellow
            'rgba(153, 102, 255, 0.5)'   // Purple
        ];

        const borderColors = [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)'
        ];

        return {
            label: uni.ten_truong,
            data: [
                rankingScore,
                teachingScore,
                facilityScore,
                employmentScore,
                researchScore,
                valueScore
            ],
            backgroundColor: colors[index % colors.length],
            borderColor: borderColors[index % borderColors.length],
            borderWidth: 2,
            pointBackgroundColor: borderColors[index % borderColors.length],
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: borderColors[index % borderColors.length]
        };
    });

    const ctx = document.getElementById('radarChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: [
                'Xếp hạng',
                'Chất lượng Giảng dạy',
                'Cơ sở Vật chất',
                'Tỷ lệ Việc làm',
                'Cơ hội Nghiên cứu',
                'Giá trị/Chi phí'
            ],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 10,
                    min: 0,
                    ticks: {
                        stepSize: 2,
                        callback: function(value) {
                            return value + '/10';
                        }
                    },
                    pointLabels: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: 15
                    }
                },
                title: {
                    display: true,
                    text: 'So sánh tổng quan - Điểm cao hơn = Tốt hơn',
                    font: {
                        size: 14
                    },
                    padding: {
                        bottom: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + '/10';
                        }
                    }
                }
            }
        }
    });
});
</script>


    {% else %}
    <!-- Welcome Section -->
    <div class="row">
        <div class="col-12">
            <div class="welcome-section text-center py-5">
                <i class="fas fa-balance-scale fa-4x text-primary mb-4"></i>
                <h2 class="fw-bold mb-3">So sánh Trường đại học Thông Minh</h2>
                <p class="lead text-muted mb-4">
                    Sử dụng công nghệ AI để so sánh chi tiết các trường đại học<br>
                    và tìm ra lựa chọn phù hợp nhất cho bạn
                </p>
                
                {% if not show_comparison_interface %}
                <div class="getting-started mb-4">
                    <h4 class="fw-bold mb-3">Cách bắt đầu:</h4>
                    <ol class="list-unstyled text-start" style="max-width: 600px; margin: 0 auto;">
                        <li class="mb-2">
                            <span class="badge bg-primary rounded-pill me-2">1</span>
                            Đi tới <a href="{% url 'university_app:tim_kiem' %}" class="text-decoration-none">trang tìm kiếm</a>
                        </li>
                        <li class="mb-2">
                            <span class="badge bg-primary rounded-pill me-2">2</span>
                            Nhấn nút <strong>"+So sánh"</strong> tại các trường bạn quan tâm
                        </li>
                        <li class="mb-2">
                            <span class="badge bg-primary rounded-pill me-2">3</span>
                            Quay lại đây để chọn chuyên ngành và so sánh
                        </li>
                    </ol>
                </div>
                
                <a href="{% url 'university_app:tim_kiem' %}" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-search me-2"></i>Bắt đầu Tìm kiếm
                </a>
                {% endif %}
                
                <div class="features-preview mt-5">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-graduation-cap fa-2x text-primary mb-3"></i>
                                <h5>So sánh Chuyên ngành</h5>
                                <p class="text-muted">Chi tiết về các chuyên ngành và yêu cầu tuyển sinh</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                                <h5>Xếp hạng & Chi Phí</h5>
                                <p class="text-muted">Thông tin xếp hạng và học phí của các trường</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-robot fa-2x text-info mb-3"></i>
                                <h5>Phân tích AI</h5>
                                <p class="text-muted">Gợi ý thông minh dựa trên dữ liệu thực tế</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .comparison-management-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .university-comparison-item {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    .university-comparison-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .major-selection-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid #e9ecef;
    }
    
    .ai-analysis-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: none !important;
        outline: none !important;
        position: relative;
        animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-analysis-section .badge {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(255, 255, 255, 0);
        }
    }

    .ai-content-wrapper {
        transition: all 0.5s ease;
        overflow: hidden;
    }

    .ai-content-wrapper.hidden {
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    .ai-content {
        background: transparent;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 0;
        border: none;
    }

    .ai-analysis-text {
        line-height: 1.8;
        font-size: 1.05rem;
        color: rgba(255, 255, 255, 0.95);
    }

    .ai-analysis-text p {
        margin-bottom: 1rem;
    }

    .ai-analysis-text strong {
        color: #fff;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .ai-analysis-text h3, .ai-analysis-text h4, .ai-analysis-text h5 {
        color: #fff;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.8rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 0.5rem;
    }

    .ai-analysis-text h3 {
        font-size: 1.3rem;
    }

    .ai-analysis-text h4 {
        font-size: 1.2rem;
    }

    .ai-analysis-text h5 {
        font-size: 1.1rem;
    }

    .ai-analysis-text ul {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .ai-analysis-text li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .ai-analysis-text em {
        font-style: italic;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .comparison-table-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: none !important;
        outline: none !important;
    }

    /* Bỏ viền ngoài, giữ viền trong nhẹ */
    .comparison-results {
        border: none !important;
        outline: none !important;
    }

    .comparison-table {
        border: none !important; /* Bỏ viền ngoài của table */
    }

    .comparison-table th,
    .comparison-table td {
        border: 1px solid #dee2e6 !important; /* Viền trong nhẹ */
        border-width: 1px !important;
    }
    
    .comparison-table th {
        background: #343a40 !important;
        color: white;
        text-align: center;
        vertical-align: middle;
    }
    
    .comparison-table .criteria-col {
        width: 200px;
        min-width: 200px;
    }
    
    .comparison-table .university-col {
        min-width: 200px;
    }
    
    .university-header-cell {
        padding: 0.5rem;
    }
    
    .university-name {
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .comparison-table td {
        vertical-align: middle;
        padding: 1rem;
    }
    
    .welcome-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .feature-card {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .getting-started {
        background: rgba(255, 255, 255, 0.8);
        padding: 2rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }

    /* Loading Overlay - Only for AI section */
    .ai-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(102, 126, 234, 0.95);
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        border-radius: 15px;
    }

    .loading-content {
        text-align: center;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Icon Spin Animation */
    .icon-spin {
        animation: iconSpin 1s linear infinite;
    }

    @keyframes iconSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .comparison-management-section {
            padding: 1.5rem 1rem;
        }
        
        .comparison-table {
            font-size: 0.875rem;
        }
        
        .ai-analysis-section {
            padding: 1.5rem;
        }
        
        .university-header-cell {
            padding: 0.25rem;
        }
        
        .university-name {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Hàm render markdown (chuyển **text** thành <strong>text</strong>)
function renderMarkdown(text) {
    if (!text) return '';

    // Chuyển đổi markdown tables trước
    text = convertMarkdownTables(text);

    // Chuyển đổi markdown sang HTML
    let html = text
        // Bold: **text** hoặc __text__
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')

        // Italic: *text* hoặc _text_
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/_(.+?)_/g, '<em>$1</em>')

        // Headers: ## Text
        .replace(/^### (.+)$/gm, '<h5 class="mt-3 mb-2">$1</h5>')
        .replace(/^## (.+)$/gm, '<h4 class="mt-4 mb-2">$1</h4>')
        .replace(/^# (.+)$/gm, '<h3 class="mt-4 mb-3">$1</h3>')

        // Bullets: - item hoặc * item
        .replace(/^[\-\*] (.+)$/gm, '<li>$1</li>')

        // Line breaks
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

    // Wrap trong <p> và <ul> cho bullets
    html = '<p>' + html + '</p>';
    html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

    // Clean up empty paragraphs
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p><br><\/p>/g, '');

    return html;
}

// Hàm convert markdown table sang HTML table
function convertMarkdownTables(text) {
    // Tìm markdown tables: | col1 | col2 |
    const tableRegex = /(\|.+\|\n)+/g;

    return text.replace(tableRegex, function(match) {
        const lines = match.trim().split('\n').filter(line => line.trim());

        if (lines.length < 2) return match;

        // Dòng đầu là header
        const headerLine = lines[0];
        const headers = headerLine.split('|')
            .map(h => h.trim())
            .filter(h => h);

        // Dòng thứ 2 là separator (bỏ qua)
        if (lines[1].includes('---')) {
            lines.shift(); // Bỏ header
            lines.shift(); // Bỏ separator
        }

        // Các dòng còn lại là data
        let html = '<table class="table table-bordered table-striped mt-3 mb-3" style="background: rgba(255,255,255,0.1); color: white;">';

        // Header
        html += '<thead style="background: rgba(255,255,255,0.2);"><tr>';
        headers.forEach(h => {
            html += '<th style="padding: 12px; border: 1px solid rgba(255,255,255,0.3);">' + h + '</th>';
        });
        html += '</tr></thead>';

        // Body
        html += '<tbody>';
        lines.forEach(line => {
            const cols = line.split('|')
                .map(c => c.trim())
                .filter(c => c);

            if (cols.length > 0) {
                html += '<tr>';
                cols.forEach(col => {
                    html += '<td style="padding: 12px; border: 1px solid rgba(255,255,255,0.3);">' + col + '</td>';
                });
                html += '</tr>';
            }
        });
        html += '</tbody></table>';

        return html;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Show AI loading section when comparing
    const compareForm = document.getElementById('compareForm');
    const aiLoadingSection = document.getElementById('aiLoadingSection');
    const pageHeaderIcon = document.getElementById('pageHeaderIcon');
    const pageHeaderSubtext = document.getElementById('pageHeaderSubtext');

    if (compareForm) {
        compareForm.addEventListener('submit', function(e) {
            const select = this.querySelector('select[name="ma_chuyen_nganh"]');
            if (select && select.value) {
                // Change header icon to spinner
                if (pageHeaderIcon) {
                    pageHeaderIcon.className = 'fas fa-spinner text-primary me-3 icon-spin';
                }

                // Change subtext
                if (pageHeaderSubtext) {
                    pageHeaderSubtext.innerHTML = '<span class="text-primary fw-bold">Đang phân tích với AI... Vui lòng đợi 10-15 giây</span>';
                }

                // Scroll to top
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

                // Show loading in AI section
                if (aiLoadingSection) {
                    aiLoadingSection.style.display = 'block';
                }
            }
        });
    }

    // Render AI analysis với markdown
    const aiAnalysisText = `{{ ket_qua_ai|escapejs }}`;
    const aiAnalysisContainer = document.getElementById('ai-analysis-rendered');

    if (aiAnalysisContainer && aiAnalysisText) {
        aiAnalysisContainer.innerHTML = renderMarkdown(aiAnalysisText);
    }

    // Toggle AI Content
    const toggleBtn = document.getElementById('toggle-ai-btn');
    const aiWrapper = document.getElementById('ai-content-wrapper');
    const toggleText = document.getElementById('toggle-text');
    
    if (toggleBtn && aiWrapper && toggleText) {
        let isHidden = false;
        
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (isHidden) {
                aiWrapper.classList.remove('hidden');
                toggleText.textContent = 'Ẩn';
                toggleBtn.querySelector('i').className = 'fas fa-eye me-2';
                isHidden = false;
            } else {
                aiWrapper.classList.add('hidden');
                toggleText.textContent = 'Hiện';
                toggleBtn.querySelector('i').className = 'fas fa-eye-slash me-2';
                isHidden = true;
            }
        });
    }
});

// Hàm lưu kết quả so sánh
function luuKetQuaSoSanh() {
    const aiContent = document.querySelector('.ai-content')?.textContent || '';
    const comparisonTitle = document.querySelector('.comparison-table-section h3')?.textContent || 'So sánh trường đại học';
    
    if (!aiContent) {
        alert('Không có kết quả so sánh để lưu.');
        return;
    }
    
    const title = prompt('Nhập tiêu đề cho kết quả so sánh:', comparisonTitle);
    if (!title) return;
    
    const data = {
        tieu_de: title,
        ket_qua_ai: aiContent
    };
    
    fetch('{% url "university_app:luu_ket_qua_so_sanh" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Đã lưu kết quả so sánh thành công!');
        } else {
            alert('Có lỗi xảy ra: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi lưu kết quả.');
    });
}
</script>
{% endblock %}