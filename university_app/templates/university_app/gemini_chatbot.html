<style>
.gemini-chatbot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
}

.gemini-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc04 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-size: 30px;
    color: white;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gemini-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

.gemini-window {
    display: none;
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 380px;
    height: 550px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    flex-direction: column;
    overflow: hidden;
}

.gemini-window.active {
    display: flex;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.gemini-header {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    color: white;
    padding: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.gemini-header h3 {
    margin: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gemini-header-title {
    display: flex;
    flex-direction: column;
}

.gemini-header-subtitle {
    font-size: 11px;
    opacity: 0.9;
    font-weight: normal;
}

.gemini-clear-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gemini-clear-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
}

.gemini-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: 0.2s;
}

.gemini-close:hover {
    background: rgba(255,255,255,0.3);
}

.gemini-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
}

.gemini-msg {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
}

.gemini-msg.user {
    align-items: flex-end;
}

.gemini-msg.bot {
    align-items: flex-start;
}

.gemini-bubble {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    white-space: pre-line;
    line-height: 1.6;
    font-size: 14px;
}

.gemini-bubble strong {
    font-weight: 600;
    color: inherit;
}

.gemini-bubble em {
    font-style: italic;
}

.gemini-bubble h4, .gemini-bubble h5, .gemini-bubble h6 {
    margin: 0.5rem 0;
    font-weight: 600;
}

.gemini-msg.bot .gemini-bubble strong {
    color: #1a73e8;
}

.gemini-msg.user .gemini-bubble strong {
    color: #fff;
    font-weight: 700;
}

.gemini-msg.user .gemini-bubble {
    background: #4285f4;
    color: white;
    border-bottom-right-radius: 4px;
}

.gemini-msg.bot .gemini-bubble {
    background: white;
    color: #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-bottom-left-radius: 4px;
}

.gemini-typing {
    display: none;
    padding: 12px 16px;
    background: white;
    border-radius: 18px;
    width: fit-content;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.gemini-typing.active {
    display: block;
}

.gemini-typing span {
    height: 8px;
    width: 8px;
    background: #4285f4;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
}

.gemini-typing span:nth-child(1) { animation-delay: -0.32s; }
.gemini-typing span:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

.gemini-input-area {
    display: flex;
    padding: 12px;
    background: white;
    border-top: 1px solid #e0e0e0;
    gap: 8px;
}

.gemini-input-area input {
    flex: 1;
    border: 1px solid #e0e0e0;
    border-radius: 24px;
    padding: 12px 16px;
    outline: none;
    font-size: 14px;
}

.gemini-input-area input:focus {
    border-color: #4285f4;
}

.gemini-send-btn {
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    cursor: pointer;
    font-size: 18px;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gemini-send-btn:hover {
    background: #3367d6;
    transform: scale(1.05);
}

.gemini-send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.gemini-suggestions {
    padding: 10px 15px;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
}

.gemini-suggestions::-webkit-scrollbar {
    display: none;
}

.gemini-suggestion-chip {
    background: white;
    border: 1px solid #e0e0e0;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
    transition: 0.2s;
}

.gemini-suggestion-chip:hover {
    background: #4285f4;
    color: white;
    border-color: #4285f4;
}
</style>

<div class="gemini-chatbot">
    <button class="gemini-btn" onclick="toggleGeminiChat()" title="Chat v·ªõi Gemini AI">
        <span style="font-size: 24px;">ü§ñ</span>
    </button>

    <div class="gemini-window" id="geminiWindow">
        <div class="gemini-header">
            <h3>
                <span>ü§ñ</span>
                <div class="gemini-header-title">
                    <div>Tr·ª£ L√Ω AI</div>
                    <div class="gemini-header-subtitle">H·ªó tr·ª£ t∆∞ v·∫•n tr∆∞·ªùng ƒë·∫°i h·ªçc</div>
                </div>
            </h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="gemini-clear-btn" onclick="confirmClearHistory()" title="X√≥a l·ªãch s·ª≠ chat">
                    üóëÔ∏è
                </button>
                <button class="gemini-close" onclick="toggleGeminiChat()">√ó</button>
            </div>
        </div>

        <div class="gemini-suggestions">
            <div class="gemini-suggestion-chip" onclick="askGemini('Tr∆∞·ªùng n√†o t·ªët cho Computer Science?')">üéì CS t·ªët nh·∫•t</div>
            <div class="gemini-suggestion-chip" onclick="askGemini('So s√°nh MIT v√† Stanford')">‚öñÔ∏è So s√°nh</div>
            <div class="gemini-suggestion-chip" onclick="askGemini('C√°c tr∆∞·ªùng ƒë·∫°i h·ªçc ·ªü M·ªπ x·∫øp h·∫°ng cao')">Top US</div>
        </div>

        <div class="gemini-messages" id="geminiMessages">
            <div class="gemini-msg bot">
                <div class="gemini-bubble">
Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa Gemini. üëã

T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:
‚Ä¢ T√¨m tr∆∞·ªùng ph√π h·ª£p v·ªõi chuy√™n ng√†nh
‚Ä¢ So s√°nh c√°c tr∆∞·ªùng ƒë·∫°i h·ªçc
‚Ä¢ T∆∞ v·∫•n v·ªÅ y√™u c·∫ßu tuy·ªÉn sinh

H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨! üí°
                </div>
            </div>
            <div class="gemini-typing" id="geminiTyping">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="gemini-input-area">
            <input
                type="text"
                id="geminiInput"
                placeholder="H·ªèi v·ªÅ tr∆∞·ªùng ƒë·∫°i h·ªçc..."
                onkeypress="if(event.key==='Enter') sendGeminiMessage()"
            >
            <button class="gemini-send-btn" onclick="sendGeminiMessage()" id="geminiSendBtn">
                <span>‚û§</span>
            </button>
        </div>
    </div>
</div>

<script>
// ============================================
// SESSION STORAGE - L∆ØU L·ªäCH S·ª¨ CHAT
// ============================================
const CHAT_HISTORY_KEY = 'gemini_chat_history';
const CHAT_STATE_KEY = 'gemini_chat_state';

// L∆∞u l·ªãch s·ª≠ chat v√†o sessionStorage
function saveChatHistory() {
    const messagesDiv = document.getElementById('geminiMessages');
    const messages = [];

    // L·∫•y t·∫•t c·∫£ messages tr·ª´ welcome message v√† typing indicator
    const msgElements = messagesDiv.querySelectorAll('.gemini-msg:not(:first-child)');
    msgElements.forEach(msg => {
        const sender = msg.classList.contains('user') ? 'user' : 'bot';
        const bubble = msg.querySelector('.gemini-bubble');

        // L∆∞u raw text g·ªëc t·ª´ data attribute (gi·ªØ markdown)
        let text;
        if (sender === 'bot') {
            text = bubble.getAttribute('data-raw-text') || bubble.textContent;
        } else {
            text = bubble.textContent;
        }

        messages.push({ sender, text });
    });

    sessionStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
}

// Kh√¥i ph·ª•c l·ªãch s·ª≠ chat t·ª´ sessionStorage
function restoreChatHistory() {
    const savedHistory = sessionStorage.getItem(CHAT_HISTORY_KEY);
    if (savedHistory) {
        const messages = JSON.parse(savedHistory);
        messages.forEach(msg => {
            addGeminiMessage(msg.text, msg.sender, false); // false = kh√¥ng l∆∞u l·∫°i
        });
    }
}

// L∆∞u tr·∫°ng th√°i m·ªü/ƒë√≥ng c·ªßa chatbot
function saveChatState(isOpen) {
    sessionStorage.setItem(CHAT_STATE_KEY, isOpen ? 'open' : 'closed');
}

// Kh√¥i ph·ª•c tr·∫°ng th√°i m·ªü/ƒë√≥ng
function restoreChatState() {
    const state = sessionStorage.getItem(CHAT_STATE_KEY);
    if (state === 'open') {
        document.getElementById('geminiWindow').classList.add('active');
    }
}

// X√≥a l·ªãch s·ª≠ chat
function clearChatHistory() {
    sessionStorage.removeItem(CHAT_HISTORY_KEY);
    sessionStorage.removeItem(CHAT_STATE_KEY);

    // X√≥a t·∫•t c·∫£ messages tr·ª´ welcome message
    const messagesDiv = document.getElementById('geminiMessages');
    const msgElements = messagesDiv.querySelectorAll('.gemini-msg:not(:first-child)');
    msgElements.forEach(msg => msg.remove());
}

// Confirm tr∆∞·ªõc khi x√≥a
function confirmClearHistory() {
    if (confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        clearChatHistory();

        // Hi·ªÉn th·ªã th√¥ng b√°o ƒë√£ x√≥a
        const messagesDiv = document.getElementById('geminiMessages');
        const tempMsg = document.createElement('div');
        tempMsg.className = 'gemini-msg bot';
        tempMsg.innerHTML = '<div class="gemini-bubble" style="background: #e8f5e9; color: #2e7d32;">‚úÖ ƒê√£ x√≥a l·ªãch s·ª≠ chat th√†nh c√¥ng!</div>';
        messagesDiv.insertBefore(tempMsg, document.getElementById('geminiTyping'));

        // T·ª± ƒë·ªông x√≥a th√¥ng b√°o sau 3 gi√¢y
        setTimeout(() => {
            tempMsg.style.transition = 'opacity 0.3s';
            tempMsg.style.opacity = '0';
            setTimeout(() => tempMsg.remove(), 300);
        }, 3000);
    }
}

// ============================================
// CHATBOT FUNCTIONS
// ============================================
function toggleGeminiChat() {
    const window = document.getElementById('geminiWindow');
    window.classList.toggle('active');

    // L∆∞u tr·∫°ng th√°i
    saveChatState(window.classList.contains('active'));

    if (window.classList.contains('active')) {
        document.getElementById('geminiInput').focus();
    }
}

function askGemini(question) {
    document.getElementById('geminiInput').value = question;
    sendGeminiMessage();
}

async function sendGeminiMessage() {
    const input = document.getElementById('geminiInput');
    const sendBtn = document.getElementById('geminiSendBtn');
    const message = input.value.trim();

    if (!message) return;

    input.disabled = true;
    sendBtn.disabled = true;

    addGeminiMessage(message, 'user');
    input.value = '';

    const typing = document.getElementById('geminiTyping');
    typing.classList.add('active');
    scrollGeminiToBottom();

    try {
        const response = await fetch('/api/chatbot-gemini/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        typing.classList.remove('active');

        if (data.success) {
            addGeminiMessage(data.answer, 'bot');
        } else {
            addGeminiMessage('‚ùå L·ªói: ' + (data.message || 'C√≥ l·ªói x·∫£y ra'), 'bot');
        }

    } catch (error) {
        typing.classList.remove('active');
        addGeminiMessage('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'bot');
        console.error(error);
    } finally {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
    }
}

function renderMarkdownSimple(text) {
    if (!text) return '';

    // Chuy·ªÉn ƒë·ªïi markdown tables tr∆∞·ªõc
    text = convertMarkdownTablesChatbot(text);

    // Chuy·ªÉn ƒë·ªïi markdown c∆° b·∫£n sang HTML
    let html = text
        // Bold: **text**
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')

        // Italic: *text*
        .replace(/(?<!\*)\*(?!\*)(.+?)\*(?!\*)/g, '<em>$1</em>')

        // Headers
        .replace(/^### (.+)$/gm, '<h6 style="margin: 0.5rem 0; font-weight: 600;">$1</h6>')
        .replace(/^## (.+)$/gm, '<h5 style="margin: 0.5rem 0; font-weight: 600;">$1</h5>')
        .replace(/^# (.+)$/gm, '<h4 style="margin: 0.5rem 0; font-weight: 600;">$1</h4>')

        // Bullets: - item ho·∫∑c * item (ch·ªâ ·ªü ƒë·∫ßu d√≤ng)
        .replace(/^[\-‚Ä¢] (.+)$/gm, '‚Ä¢ $1')

        // Line breaks (gi·ªØ nguy√™n \n)
        .replace(/\n/g, '<br>');

    return html;
}

// H√†m convert markdown table sang HTML table cho chatbot
function convertMarkdownTablesChatbot(text) {
    const tableRegex = /(\|.+\|\n)+/g;

    return text.replace(tableRegex, function(match) {
        const lines = match.trim().split('\n').filter(line => line.trim());
        if (lines.length < 2) return match;

        const headerLine = lines[0];
        const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);

        if (lines[1].includes('---')) {
            lines.shift();
            lines.shift();
        }

        let html = '<table style="width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 13px; background: #f8f9fa; color: #333;">';

        // Header
        html += '<thead style="background: #e9ecef;"><tr>';
        headers.forEach(h => {
            html += '<th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">' + h + '</th>';
        });
        html += '</tr></thead>';

        // Body
        html += '<tbody>';
        lines.forEach(line => {
            const cols = line.split('|').map(c => c.trim()).filter(c => c);
            if (cols.length > 0) {
                html += '<tr>';
                cols.forEach(col => {
                    html += '<td style="padding: 8px; border: 1px solid #dee2e6;">' + col + '</td>';
                });
                html += '</tr>';
            }
        });
        html += '</tbody></table>';

        return html;
    });
}

function addGeminiMessage(text, sender, shouldSave = true) {
    const messagesDiv = document.getElementById('geminiMessages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'gemini-msg ' + sender;

    const bubble = document.createElement('div');
    bubble.className = 'gemini-bubble';

    // Render markdown cho bot messages, plain text cho user messages
    if (sender === 'bot') {
        // L∆∞u raw text v√†o data attribute ƒë·ªÉ restore sau
        bubble.setAttribute('data-raw-text', text);
        bubble.innerHTML = renderMarkdownSimple(text);
    } else {
        bubble.textContent = text;
    }

    msgDiv.appendChild(bubble);
    messagesDiv.insertBefore(msgDiv, document.getElementById('geminiTyping'));

    scrollGeminiToBottom();

    // L∆∞u v√†o sessionStorage
    if (shouldSave) {
        saveChatHistory();
    }
}

function scrollGeminiToBottom() {
    const messagesDiv = document.getElementById('geminiMessages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================
// KH·ªûI T·∫†O KHI TRANG LOAD
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // Kh√¥i ph·ª•c l·ªãch s·ª≠ chat v√† tr·∫°ng th√°i
    restoreChatHistory();
    restoreChatState();
});
</script>
